<style>
#replay-map { width: 100%; height: calc(100vh - 120px); }
#controls {
    background: #111;
    border-top: 1px solid #333;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    height: 79px;
}
#time-slider { flex: 1; accent-color: #00ff88; }
#time-display { color: #00ff88; font-size: 14px; font-weight: bold; min-width: 200px; }
.ctrl-btn {
    background: #222;
    color: #00ff88;
    border: 1px solid #333;
    padding: 8px 16px;
    cursor: pointer;
    font-family: 'Courier New', monospace;
    border-radius: 3px;
}
.ctrl-btn:hover { border-color: #00ff88; }
.ctrl-btn.active { background: #00ff88; color: #000; }
#speed-label { color: #888; font-size: 12px; }
.leaflet-container { background: #0a0a0a; }
</style>
<div id="replay-map"></div>
<div id="controls">
    <button class="ctrl-btn" id="play-btn">Play</button>
    <input type="range" id="time-slider" min="0" max="100" value="0">
    <span id="time-display">Loading...</span>
    <button class="ctrl-btn" id="speed-down">-</button>
    <span id="speed-label" style="min-width:40px;text-align:center;">1x</span>
    <button class="ctrl-btn" id="speed-up">+</button>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('replay-map', { zoomControl: true });
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OSM &copy; CARTO', maxZoom: 19,
}).addTo(map);

let allPositions = [];
let timeMin = 0, timeMax = 0;
let playing = false;
let currentTime = 0;
let playSpeed = 1;
const speeds = [1, 2, 5, 10, 30, 60, 120, 300, 600];
let speedIdx = 0;
const markers = {};
const trails = {};

function altColor(alt) {
    if (alt == null) return '#888';
    const t = Math.min(Math.max(alt / 40000, 0), 1);
    if (t < 0.5) {
        const s = t * 2;
        return `rgb(${Math.round(s * 255)},255,0)`;
    } else {
        const s = (t - 0.5) * 2;
        return `rgb(255,${Math.round((1 - s) * 255)},0)`;
    }
}

function classifyAircraft(p) {
    if (p.is_military) return 'military';
    if (p.speed_kts != null) {
        if (p.speed_kts > 250) return 'jet';
        if (p.speed_kts < 80 && p.altitude_ft != null && p.altitude_ft < 3000) return 'helicopter';
        if (p.speed_kts <= 180) return 'prop';
        if (p.speed_kts <= 250) return 'turboprop';
    }
    if (p.altitude_ft != null) {
        if (p.altitude_ft > 30000) return 'jet';
        if (p.altitude_ft < 5000) return 'prop';
    }
    return 'jet';
}

const acSvgs = {
    jet: (color) => `<path d="M12,2 L14,8 L14,10 L22,14 L22,16 L14,14 L14,19 L17,21 L17,23 L12,21 L7,23 L7,21 L10,19 L10,14 L2,16 L2,14 L10,10 L10,8 Z" fill="${color}" stroke="#000" stroke-width="0.4"/>`,
    prop: (color) => `<path d="M12,3 L13.5,9 L13,10 L18,13 L18,14.5 L13,13 L13,19 L15,21 L15,22.5 L12,21 L9,22.5 L9,21 L11,19 L11,13 L6,14.5 L6,13 L11,10 L10.5,9 Z" fill="${color}" stroke="#000" stroke-width="0.4"/>`,
    turboprop: (color) => `<path d="M12,2.5 L13.5,8.5 L13.5,10 L20,13.5 L20,15 L13.5,13 L13.5,19 L16,21 L16,22.5 L12,21 L8,22.5 L8,21 L10.5,19 L10.5,13 L4,15 L4,13.5 L10.5,10 L10.5,8.5 Z" fill="${color}" stroke="#000" stroke-width="0.4"/>`,
    helicopter: (color) => `<circle cx="12" cy="13" r="4" fill="${color}" stroke="#000" stroke-width="0.4"/>
        <line x1="4" y1="9" x2="20" y2="9" stroke="${color}" stroke-width="1.5"/>
        <line x1="12" y1="9" x2="12" y2="13" stroke="${color}" stroke-width="1"/>
        <line x1="10" y1="17" x2="14" y2="17" stroke="${color}" stroke-width="1"/>
        <line x1="12" y1="17" x2="12" y2="21" stroke="${color}" stroke-width="1"/>
        <line x1="9" y1="21" x2="15" y2="21" stroke="${color}" stroke-width="1.2"/>`,
    military: (color) => `<path d="M12,1 L14.5,7 L14,9 L22,12 L22,14 L14,12.5 L14,18 L17,20.5 L17,22 L12,20 L7,22 L7,20.5 L10,18 L10,12.5 L2,14 L2,12 L10,9 L9.5,7 Z" fill="${color}" stroke="#000" stroke-width="0.5"/>`,
};

function acIcon(heading, isMilitary, acType) {
    const color = isMilitary ? '#ff4444' : '#00ff88';
    const type = acType || (isMilitary ? 'military' : 'jet');
    const svgBody = (acSvgs[type] || acSvgs.jet)(color);
    const rotation = heading || 0;
    return L.divIcon({
        className: '',
        html: `<svg width="24" height="24" viewBox="0 0 24 24" style="transform:rotate(${rotation}deg)">${svgBody}</svg>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12],
    });
}

fetch('/api/positions/all')
    .then(r => r.json())
    .then(data => {
        allPositions = data;
        if (allPositions.length === 0) {
            document.getElementById('time-display').textContent = 'No position data';
            return;
        }
        timeMin = allPositions[0].timestamp;
        timeMax = allPositions[allPositions.length - 1].timestamp;
        currentTime = timeMin;
        map.setView([allPositions[0].lat, allPositions[0].lon], 8);
        updateDisplay();
    })
    .catch(err => {
        document.getElementById('time-display').textContent = 'Load failed';
        console.error(err);
    });

function updateDisplay() {
    const slider = document.getElementById('time-slider');
    const pct = ((currentTime - timeMin) / (timeMax - timeMin)) * 100;
    slider.value = pct;

    const d = new Date(currentTime * 1000);
    document.getElementById('time-display').textContent =
        d.toLocaleDateString() + ' ' + d.toLocaleTimeString();

    const latest = {};
    const trailPoints = {};
    for (const p of allPositions) {
        if (p.timestamp > currentTime) break;
        latest[p.icao] = p;
        if (!trailPoints[p.icao]) trailPoints[p.icao] = [];
        trailPoints[p.icao].push(p);
    }

    const seen = new Set();
    Object.entries(latest).forEach(([icao, p]) => {
        seen.add(icao);
        const acType = classifyAircraft(p);
        if (markers[icao]) {
            markers[icao].setLatLng([p.lat, p.lon]);
            markers[icao].setIcon(acIcon(p.heading_deg, p.is_military, acType));
        } else {
            markers[icao] = L.marker([p.lat, p.lon], {
                icon: acIcon(p.heading_deg, p.is_military, acType),
            }).addTo(map);
        }
        const label = p.callsign || p.registration || p.icao;
        markers[icao].bindTooltip(label, { permanent: false, direction: 'right' });

        if (trails[icao]) { trails[icao].forEach(s => map.removeLayer(s)); }
        trails[icao] = [];
        const pts = trailPoints[icao] || [];
        for (let i = 1; i < pts.length; i++) {
            const seg = L.polyline(
                [[pts[i-1].lat, pts[i-1].lon], [pts[i].lat, pts[i].lon]],
                { color: altColor(pts[i].altitude_ft), weight: 2, opacity: 0.6 }
            ).addTo(map);
            trails[icao].push(seg);
        }
    });

    Object.keys(markers).forEach(k => {
        if (!seen.has(k)) {
            map.removeLayer(markers[k]);
            delete markers[k];
            if (trails[k]) { trails[k].forEach(s => map.removeLayer(s)); delete trails[k]; }
        }
    });
}

document.getElementById('play-btn').addEventListener('click', function() {
    playing = !playing;
    this.textContent = playing ? 'Pause' : 'Play';
    this.classList.toggle('active', playing);
});

function updateSpeedLabel() {
    const s = speeds[speedIdx];
    document.getElementById('speed-label').textContent = (s >= 60 ? (s/60) + 'm' : s) + 'x';
    playSpeed = s;
}
document.getElementById('speed-up').addEventListener('click', function() {
    if (speedIdx < speeds.length - 1) speedIdx++;
    updateSpeedLabel();
});
document.getElementById('speed-down').addEventListener('click', function() {
    if (speedIdx > 0) speedIdx--;
    updateSpeedLabel();
});

document.getElementById('time-slider').addEventListener('input', function() {
    const pct = this.value / 100;
    currentTime = timeMin + pct * (timeMax - timeMin);
    updateDisplay();
});

setInterval(() => {
    if (!playing || timeMax <= timeMin) return;
    currentTime += playSpeed;
    if (currentTime > timeMax) {
        currentTime = timeMin;
    }
    updateDisplay();
}, 100);
</script>
