<style>
#detail-split {
    display: flex;
    height: calc(100vh - 41px);
    overflow: hidden;
}
#left-panel {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    border-right: 1px solid #333;
    min-width: 0;
}
#right-panel {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    min-width: 0;
}
#detail-map {
    width: 100%;
    height: 300px;
    border: 1px solid #333;
    border-radius: 4px;
    margin: 12px 0;
}
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 6px;
    margin: 10px 0;
}
.info-item {
    background: #111;
    padding: 8px 10px;
    border: 1px solid #222;
    border-radius: 3px;
}
.info-item .label { color: #888; font-size: 10px; text-transform: uppercase; }
.info-item .value { color: #00ff88; font-size: 15px; font-weight: bold; }
.info-item .value.mil { color: #ff4444; }

.section-hdr {
    color: #00ff88;
    font-size: 14px;
    margin: 16px 0 8px;
    padding-bottom: 4px;
    border-bottom: 1px solid #222;
}
.event-item {
    background: #111;
    border: 1px solid #222;
    border-radius: 3px;
    padding: 8px 10px;
    margin-bottom: 6px;
    font-size: 12px;
}
.event-item .event-type {
    font-weight: bold;
    text-transform: uppercase;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 2px;
    display: inline-block;
    margin-bottom: 4px;
}
.event-type.military { background: #442222; color: #ff6666; }
.event-type.emergency { background: #442200; color: #ffaa44; }
.event-type.anomaly { background: #333300; color: #ffff66; }

.ext-links {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin: 10px 0;
}
.ext-link {
    display: block;
    background: #111;
    border: 1px solid #333;
    border-radius: 4px;
    padding: 12px;
    text-decoration: none;
    color: #e0e0e0;
    transition: border-color 0.2s;
}
.ext-link:hover { border-color: #00ff88; }
.ext-link .ext-name { color: #00aaff; font-weight: bold; font-size: 13px; }
.ext-link .ext-desc { color: #888; font-size: 11px; margin-top: 4px; }

#pos-table { font-size: 11px; margin-top: 8px; }
#pos-table th { position: sticky; top: 0; background: #0a0a0a; }

.leaflet-container { background: #0a0a0a; }
.leaflet-popup-content-wrapper { background: #111; color: #e0e0e0; border: 1px solid #333; }
.leaflet-popup-tip { background: #111; }
</style>
<div id="detail-split">
    <div id="left-panel">
        <h2 id="ac-header" style="color:#00ff88; margin:0 0 8px; font-size:18px;">Loading...</h2>
        <div class="info-grid" id="info-grid"></div>
        <div id="detail-map" style="display:none;"></div>
        <div id="events-section"></div>
        <div id="positions-section"></div>
    </div>
    <div id="right-panel">
        <div class="section-hdr">Aircraft Database Lookup</div>
        <div id="lookup-status" style="color:#888;font-size:12px;margin:8px 0;">Loading external data...</div>
        <div id="lookup-data" style="display:none;">
            <div class="info-grid">
                <div class="info-item">
                    <div class="label">Manufacturer</div>
                    <div class="value" id="lu-manufacturer">-</div>
                </div>
                <div class="info-item">
                    <div class="label">Aircraft Type</div>
                    <div class="value" id="lu-type">-</div>
                </div>
                <div class="info-item">
                    <div class="label">Type Code</div>
                    <div class="value" id="lu-typecode">-</div>
                </div>
                <div class="info-item">
                    <div class="label">Registered Owner</div>
                    <div class="value" id="lu-owner">-</div>
                </div>
                <div class="info-item">
                    <div class="label">Registration</div>
                    <div class="value" id="lu-reg">-</div>
                </div>
                <div class="info-item">
                    <div class="label">Source</div>
                    <div class="value" id="lu-source" style="font-size:11px;">-</div>
                </div>
            </div>
        </div>
        <div class="section-hdr" style="margin-top:20px;">Look Up On</div>
        <div class="ext-links" id="ext-links"></div>
        <div id="profile-section"></div>
    </div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const icao = window.location.pathname.split('/').pop().toUpperCase();

function altColor(alt) {
    if (alt == null) return '#888';
    const t = Math.min(Math.max(alt / 40000, 0), 1);
    if (t < 0.5) {
        const s = t * 2;
        return `rgb(${Math.round(s * 255)},255,0)`;
    } else {
        const s = (t - 0.5) * 2;
        return `rgb(255,${Math.round((1 - s) * 255)},0)`;
    }
}

function fmtTime(ts) {
    if (!ts) return '-';
    return new Date(ts * 1000).toLocaleTimeString();
}

function fmtDateTime(ts) {
    if (!ts) return '-';
    const d = new Date(ts * 1000);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
}

fetch(`/api/aircraft/${icao}`)
    .then(r => { if (!r.ok) throw new Error('Not found'); return r.json(); })
    .then(data => {
        const ac = data.aircraft;
        const positions = data.positions || [];
        const events = data.events || [];

        // Header
        let hdr = ac.icao;
        if (ac.registration) hdr += ' \u2014 ' + ac.registration;
        if (ac.is_military) hdr += '<span style="color:#ff4444;"> [MIL]</span>';
        document.getElementById('ac-header').innerHTML = hdr;
        document.title = 'adsb-decode \u2014 ' + ac.icao;

        // Info grid
        const grid = document.getElementById('info-grid');
        const items = [
            ['Country', ac.country || '\u2014'],
            ['Registration', ac.registration || '\u2014'],
        ];
        if (ac.callsign) items.push(['Callsign', ac.callsign]);
        if (ac.squawk) items.push(['Squawk', ac.squawk]);
        items.push(['Positions', positions.length]);
        items.push(['First Seen', fmtDateTime(ac.first_seen)]);
        items.push(['Last Seen', fmtDateTime(ac.last_seen)]);
        if (positions.length > 0) {
            const last = positions[0];
            items.push(['Last Altitude', (last.altitude_ft || '\u2014') + ' ft']);
            items.push(['Last Speed', (last.speed_kts ? Math.round(last.speed_kts) : '\u2014') + ' kts']);
            items.push(['Last Heading', (last.heading_deg ? Math.round(last.heading_deg) + '\u00B0' : '\u2014')]);
        }
        grid.innerHTML = items.map(([label, value]) =>
            `<div class="info-item"><div class="label">${label}</div><div class="value">${value}</div></div>`
        ).join('');

        // Map with trail
        if (positions.length > 0) {
            document.getElementById('detail-map').style.display = 'block';
            const dmap = L.map('detail-map', { zoomControl: true });
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OSM &copy; CARTO', maxZoom: 19,
            }).addTo(dmap);

            const pts = [...positions].reverse();
            const allCoords = [];
            for (let i = 1; i < pts.length; i++) {
                const p0 = pts[i-1], p1 = pts[i];
                const color = altColor(p1.altitude_ft);
                const opacity = 0.4 + 0.6 * (i / pts.length);
                L.polyline([[p0.lat, p0.lon], [p1.lat, p1.lon]], {
                    color: color, weight: 3, opacity: opacity,
                }).addTo(dmap);
                if (i === 1) allCoords.push([p0.lat, p0.lon]);
                allCoords.push([p1.lat, p1.lon]);
            }

            if (allCoords.length >= 2) {
                L.circleMarker(allCoords[0], { radius: 6, color: '#00aaff', fillOpacity: 0.8 })
                    .bindTooltip('First position').addTo(dmap);
                L.circleMarker(allCoords[allCoords.length - 1], { radius: 6, color: '#ff4444', fillOpacity: 0.8 })
                    .bindTooltip('Latest position').addTo(dmap);
                dmap.fitBounds(L.polyline(allCoords).getBounds().pad(0.15));
            }
        }

        // Events
        if (events.length > 0) {
            const section = document.getElementById('events-section');
            let html = `<div class="section-hdr">Events (${events.length})</div>`;
            events.slice(0, 10).forEach(e => {
                const cls = (e.event_type || '').includes('military') ? 'military' :
                            (e.event_type || '').includes('emergency') ? 'emergency' : 'anomaly';
                html += `<div class="event-item">
                    <span class="event-type ${cls}">${e.event_type}</span>
                    <div style="color:#ccc;">${e.description}</div>
                    <div style="color:#666;font-size:10px;">${fmtTime(e.timestamp)}</div>
                </div>`;
            });
            if (events.length > 10) html += `<div style="color:#666;font-size:11px;">+ ${events.length - 10} more events</div>`;
            section.innerHTML = html;
        }

        // Position table
        if (positions.length > 0) {
            const section = document.getElementById('positions-section');
            let html = '<div class="section-hdr">Position History</div>';
            html += '<div style="max-height:300px;overflow-y:auto;">';
            html += '<table id="pos-table"><thead><tr><th>Time</th><th>Lat</th><th>Lon</th><th>Alt</th><th>Spd</th><th>Hdg</th><th>VRate</th></tr></thead><tbody>';
            positions.forEach(p => {
                html += `<tr>
                    <td>${fmtTime(p.timestamp)}</td>
                    <td>${p.lat.toFixed(4)}</td>
                    <td>${p.lon.toFixed(4)}</td>
                    <td>${p.altitude_ft || '\u2014'}</td>
                    <td>${p.speed_kts ? Math.round(p.speed_kts) : '\u2014'}</td>
                    <td>${p.heading_deg ? Math.round(p.heading_deg) + '\u00B0' : '\u2014'}</td>
                    <td>${p.vertical_rate_fpm || '\u2014'}</td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            section.innerHTML = html;
        }

        // External links
        const links = document.getElementById('ext-links');
        let linkHtml = `<a class="ext-link" href="https://globe.adsbexchange.com/?icao=${icao}" target="_blank" rel="noopener">
            <div class="ext-name">ADSBExchange</div>
            <div class="ext-desc">Live global tracking, full history</div>
        </a>`;
        if (ac.registration) {
            linkHtml += `<a class="ext-link" href="https://www.planespotters.net/search?q=${ac.registration}" target="_blank" rel="noopener">
                <div class="ext-name">Planespotters</div><div class="ext-desc">Aircraft photos & fleet info</div></a>`;
            linkHtml += `<a class="ext-link" href="https://flightaware.com/live/flight/${ac.registration}" target="_blank" rel="noopener">
                <div class="ext-name">FlightAware</div><div class="ext-desc">Flight tracking & history</div></a>`;
            linkHtml += `<a class="ext-link" href="https://www.flightradar24.com/data/aircraft/${ac.registration.toLowerCase()}" target="_blank" rel="noopener">
                <div class="ext-name">FlightRadar24</div><div class="ext-desc">Real-time tracking</div></a>`;
        } else {
            linkHtml += `<a class="ext-link" href="https://www.planespotters.net/hex/${icao}" target="_blank" rel="noopener">
                <div class="ext-name">Planespotters</div><div class="ext-desc">Aircraft photos by hex</div></a>`;
            linkHtml += `<a class="ext-link" href="https://flightaware.com/live/modes/${icao}" target="_blank" rel="noopener">
                <div class="ext-name">FlightAware</div><div class="ext-desc">Flight tracking by hex</div></a>`;
        }
        if (ac.country === 'United States' && ac.registration) {
            linkHtml += `<a class="ext-link" href="https://registry.faa.gov/AircraftInquiry/Search/NNumberResult?nNumberTxt=${ac.registration.slice(1)}" target="_blank" rel="noopener">
                <div class="ext-name">FAA Registry</div><div class="ext-desc">Official registration, owner, type</div></a>`;
        }
        linkHtml += `<a class="ext-link" href="https://opensky-network.org/aircraft-profile?icao24=${icao.toLowerCase()}" target="_blank" rel="noopener">
            <div class="ext-name">OpenSky Network</div><div class="ext-desc">Aircraft metadata database</div></a>`;
        links.innerHTML = linkHtml;

        // Altitude profile chart
        if (positions.length > 1) {
            const section = document.getElementById('profile-section');
            section.innerHTML = '<div class="section-hdr" style="margin-top:20px;">Flight Profile</div><canvas id="alt-chart" style="width:100%;height:200px;background:#111;border:1px solid #222;border-radius:4px;"></canvas>';
            const canvas = document.getElementById('alt-chart');
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            const W = rect.width, H = rect.height;
            const pad = { top: 20, right: 15, bottom: 30, left: 55 };

            const pts = [...positions].reverse();
            const alts = pts.map(p => p.altitude_ft || 0);
            const times = pts.map(p => p.timestamp);
            const minT = times[0], maxT = times[times.length - 1];
            const maxAlt = Math.max(...alts, 1000);

            ctx.strokeStyle = '#222'; ctx.lineWidth = 0.5;
            for (let a = 0; a <= maxAlt; a += 10000) {
                const y = pad.top + (1 - a / maxAlt) * (H - pad.top - pad.bottom);
                ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
                ctx.fillStyle = '#666'; ctx.font = '10px monospace'; ctx.textAlign = 'right';
                ctx.fillText((a / 1000) + 'k', pad.left - 5, y + 4);
            }
            ctx.save(); ctx.translate(12, H / 2); ctx.rotate(-Math.PI / 2);
            ctx.fillStyle = '#888'; ctx.font = '10px monospace'; ctx.textAlign = 'center';
            ctx.fillText('Altitude (ft)', 0, 0); ctx.restore();

            ctx.fillStyle = '#666'; ctx.font = '10px monospace'; ctx.textAlign = 'center';
            ctx.fillText(new Date(minT * 1000).toLocaleTimeString(), pad.left, H - 8);
            ctx.fillText(new Date(maxT * 1000).toLocaleTimeString(), W - pad.right, H - 8);

            for (let i = 1; i < pts.length; i++) {
                const x0 = pad.left + ((times[i-1] - minT) / (maxT - minT || 1)) * (W - pad.left - pad.right);
                const y0 = pad.top + (1 - alts[i-1] / maxAlt) * (H - pad.top - pad.bottom);
                const x1 = pad.left + ((times[i] - minT) / (maxT - minT || 1)) * (W - pad.left - pad.right);
                const y1 = pad.top + (1 - alts[i] / maxAlt) * (H - pad.top - pad.bottom);
                ctx.strokeStyle = altColor(alts[i]); ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(x0, y0); ctx.lineTo(x1, y1); ctx.stroke();
            }
        }
    })
    .catch(err => {
        document.getElementById('ac-header').textContent = 'Aircraft not found';
        console.error(err);
    });

// External lookup via hexdb.io proxy
fetch(`/api/lookup/${icao}`)
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            document.getElementById('lookup-status').textContent = 'External lookup failed';
            return;
        }
        document.getElementById('lookup-status').style.display = 'none';
        document.getElementById('lookup-data').style.display = 'block';
        document.getElementById('lu-manufacturer').textContent = data.manufacturer || '\u2014';
        document.getElementById('lu-type').textContent = data.type || '\u2014';
        document.getElementById('lu-typecode').textContent = data.type_code || '\u2014';
        document.getElementById('lu-owner').textContent = data.owner || '\u2014';
        document.getElementById('lu-reg').textContent = data.registration || '\u2014';
        document.getElementById('lu-source').textContent = data.source || '\u2014';
    })
    .catch(() => {
        document.getElementById('lookup-status').textContent = 'External lookup unavailable';
    });
</script>
