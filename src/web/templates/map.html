{% extends "base.html" %}
{% block title %}adsb-decode — Map{% endblock %}

{% block extra_style %}
#map { width: 100%; height: calc(100vh - 41px); }
#sidebar {
    position: absolute;
    top: 49px;
    right: 0;
    width: 360px;
    height: calc(100vh - 41px);
    background: rgba(10,10,10,0.92);
    border-left: 1px solid #333;
    overflow-y: auto;
    z-index: 1000;
    font-size: 12px;
    padding: 8px;
}
#sidebar h3 { color: #00ff88; margin: 8px 0 4px; font-size: 13px; }
#sidebar table { width: 100%; }
#sidebar td { padding: 3px 6px; }
#sidebar td a { cursor: pointer; }

/* Stats overlay - top left under zoom controls */
#stats-overlay {
    position: absolute;
    top: 56px;
    left: 56px;
    background: rgba(0,0,0,0.85);
    color: #e0e0e0;
    padding: 10px 14px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 1000;
    border: 1px solid #333;
    line-height: 1.6;
    min-width: 180px;
}
#stats-overlay .stat-label { color: #888; }
#stats-overlay .stat-value { color: #00ff88; font-weight: bold; float: right; }

.leaflet-container { background: #0a0a0a; }

/* Altitude legend */
#alt-legend {
    position: absolute;
    bottom: 24px;
    left: 12px;
    background: rgba(0,0,0,0.85);
    border: 1px solid #333;
    border-radius: 4px;
    padding: 8px 12px 8px 10px;
    z-index: 1000;
    font-size: 11px;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}
#alt-legend .legend-title { color: #888; margin-bottom: 6px; font-size: 10px; text-transform: uppercase; }
#alt-legend .legend-body { display: flex; align-items: stretch; }
#alt-legend .legend-bar {
    width: 14px;
    height: 120px;
    background: linear-gradient(to top, #00ff00, #ffff00 50%, #ff0000);
    border-radius: 2px;
    flex-shrink: 0;
}
#alt-legend .legend-labels {
    margin-left: 6px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 120px;
}
#alt-legend .legend-labels span {
    color: #aaa;
    white-space: nowrap;
    line-height: 1;
}

/* Popup styling */
.ac-popup { font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.5; }
.ac-popup .popup-title { color: #00ff88; font-weight: bold; font-size: 14px; margin-bottom: 4px; }
.ac-popup .popup-row { display: flex; justify-content: space-between; gap: 12px; }
.ac-popup .popup-label { color: #888; }
.ac-popup .popup-value { font-weight: bold; }
.ac-popup .popup-mil { color: #ff4444; }
.ac-popup a { color: #00aaff; }
.leaflet-popup-content-wrapper { background: #111; color: #e0e0e0; border: 1px solid #333; }
.leaflet-popup-tip { background: #111; }
{% endblock %}

{% block content %}
<div id="map"></div>
<div id="stats-overlay">
    <div><span class="stat-label">Aircraft:</span> <span class="stat-value" id="so-aircraft">0</span></div>
    <div><span class="stat-label">Positions:</span> <span class="stat-value" id="so-positions">0</span></div>
    <div><span class="stat-label">Events:</span> <span class="stat-value" id="so-events">0</span></div>
    <div><span class="stat-label">Uptime:</span> <span class="stat-value" id="so-uptime">--</span></div>
    <div style="margin-top:8px;border-top:1px solid #333;padding-top:6px;">
        <label style="cursor:pointer;font-size:11px;"><input type="checkbox" id="trail-toggle" checked> Trails</label>
        <label style="cursor:pointer;font-size:11px;margin-left:8px;"><input type="checkbox" id="heatmap-toggle"> Heatmap</label>
        <label style="cursor:pointer;font-size:11px;margin-left:8px;"><input type="checkbox" id="apt-large"> Major</label>
        <label style="cursor:pointer;font-size:11px;margin-left:6px;"><input type="checkbox" id="apt-medium"> Medium</label>
        <label style="cursor:pointer;font-size:11px;margin-left:6px;"><input type="checkbox" id="apt-small"> Small</label>
    </div>
    <div id="trail-duration" style="margin-top:6px;border-top:1px solid #333;padding-top:6px;">
        <span style="font-size:10px;color:#888;">Trail duration:</span>
        <span style="font-size:11px;color:#00ff88;float:right;" id="trail-dur-label">1h</span>
        <input type="range" id="trail-dur-slider" min="0" max="7" value="3" style="width:100%;accent-color:#00ff88;margin-top:2px;">
    </div>
</div>
<div id="alt-legend">
    <div class="legend-title">Altitude</div>
    <div class="legend-body">
        <div class="legend-bar"></div>
        <div class="legend-labels">
            <span>40,000 ft</span>
            <span>30,000 ft</span>
            <span>20,000 ft</span>
            <span>10,000 ft</span>
            <span>0 ft</span>
        </div>
    </div>
</div>
<div id="sidebar">
    <h3>Aircraft (<span id="ac-count">0</span>)</h3>
    <table id="ac-table">
        <thead>
            <tr><th>ICAO</th><th>Call</th><th>Alt</th><th>Spd</th><th>Hdg</th></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script>
// --- Map initialization ---
const map = L.map('map', {
    center: [35.18, -83.38],  // Default, overridden by receiver location
    zoom: 7,
    zoomControl: true,
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OSM &copy; CARTO',
    maxZoom: 19,
}).addTo(map);

const markers = {};
const trailLines = {};
let mapCentered = false;

// --- Aircraft type classification (client-side) ---
function classifyAircraft(p) {
    if (p.is_military) return 'military';
    if (p.speed_kts != null) {
        if (p.speed_kts > 250) return 'jet';
        if (p.speed_kts < 80 && p.altitude_ft != null && p.altitude_ft < 3000) return 'helicopter';
        if (p.speed_kts <= 180) return 'prop';
        if (p.speed_kts <= 250) return 'turboprop';
    }
    if (p.altitude_ft != null) {
        if (p.altitude_ft > 30000) return 'jet';
        if (p.altitude_ft < 5000) return 'prop';
    }
    return 'jet'; // default
}

// --- Aircraft silhouette SVGs ---
const acSvgs = {
    jet: (color) => `<path d="M12,2 L14,8 L14,10 L22,14 L22,16 L14,14 L14,19 L17,21 L17,23 L12,21 L7,23 L7,21 L10,19 L10,14 L2,16 L2,14 L10,10 L10,8 Z" fill="${color}" stroke="#000" stroke-width="0.4"/>`,
    prop: (color) => `<path d="M12,3 L13.5,9 L13,10 L18,13 L18,14.5 L13,13 L13,19 L15,21 L15,22.5 L12,21 L9,22.5 L9,21 L11,19 L11,13 L6,14.5 L6,13 L11,10 L10.5,9 Z" fill="${color}" stroke="#000" stroke-width="0.4"/>`,
    turboprop: (color) => `<path d="M12,2.5 L13.5,8.5 L13.5,10 L20,13.5 L20,15 L13.5,13 L13.5,19 L16,21 L16,22.5 L12,21 L8,22.5 L8,21 L10.5,19 L10.5,13 L4,15 L4,13.5 L10.5,10 L10.5,8.5 Z" fill="${color}" stroke="#000" stroke-width="0.4"/>`,
    helicopter: (color) => `<circle cx="12" cy="13" r="4" fill="${color}" stroke="#000" stroke-width="0.4"/>
        <line x1="4" y1="9" x2="20" y2="9" stroke="${color}" stroke-width="1.5"/>
        <line x1="12" y1="9" x2="12" y2="13" stroke="${color}" stroke-width="1"/>
        <line x1="10" y1="17" x2="14" y2="17" stroke="${color}" stroke-width="1"/>
        <line x1="12" y1="17" x2="12" y2="21" stroke="${color}" stroke-width="1"/>
        <line x1="9" y1="21" x2="15" y2="21" stroke="${color}" stroke-width="1.2"/>`,
    military: (color) => `<path d="M12,1 L14.5,7 L14,9 L22,12 L22,14 L14,12.5 L14,18 L17,20.5 L17,22 L12,20 L7,22 L7,20.5 L10,18 L10,12.5 L2,14 L2,12 L10,9 L9.5,7 Z" fill="${color}" stroke="#000" stroke-width="0.5"/>`,
};

function acIcon(heading, isMilitary, acType) {
    const color = isMilitary ? '#ff4444' : '#00ff88';
    const type = acType || (isMilitary ? 'military' : 'jet');
    const svgBody = (acSvgs[type] || acSvgs.jet)(color);
    const rotation = heading || 0;
    return L.divIcon({
        className: '',
        html: `<svg width="24" height="24" viewBox="0 0 24 24" style="transform:rotate(${rotation}deg)">${svgBody}</svg>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12],
    });
}

// --- Altitude → color gradient ---
function altColor(alt) {
    if (alt == null) return '#888';
    // Green (low, 0ft) → Yellow (mid, 20000ft) → Red (high, 40000ft+)
    const t = Math.min(Math.max(alt / 40000, 0), 1);
    if (t < 0.5) {
        // Green → Yellow
        const s = t * 2;
        const r = Math.round(s * 255);
        const g = 255;
        return `rgb(${r},${g},0)`;
    } else {
        // Yellow → Red
        const s = (t - 0.5) * 2;
        const r = 255;
        const g = Math.round((1 - s) * 255);
        return `rgb(${r},${g},0)`;
    }
}

// --- Build popup content ---
function popupHtml(p, acType) {
    const mil = p.is_military ? '<span class="popup-mil"> [MIL]</span>' : '';
    const name = p.callsign || p.registration || p.icao;
    const typeLabel = (acType || 'unknown').charAt(0).toUpperCase() + (acType || 'unknown').slice(1);
    const hexIcao = p.icao.toUpperCase();
    return `<div class="ac-popup">
        <div class="popup-title">${name}${mil}</div>
        <div class="popup-row"><span class="popup-label">ICAO</span><span class="popup-value">${p.icao}</span></div>
        <div class="popup-row"><span class="popup-label">Type</span><span class="popup-value">${typeLabel}</span></div>
        ${p.callsign ? `<div class="popup-row"><span class="popup-label">Callsign</span><span class="popup-value">${p.callsign}</span></div>` : ''}
        ${p.registration ? `<div class="popup-row"><span class="popup-label">Reg</span><span class="popup-value">${p.registration}</span></div>` : ''}
        ${p.country ? `<div class="popup-row"><span class="popup-label">Country</span><span class="popup-value">${p.country}</span></div>` : ''}
        <div class="popup-row"><span class="popup-label">Altitude</span><span class="popup-value">${p.altitude_ft != null ? p.altitude_ft.toLocaleString() + ' ft' : '--'}</span></div>
        <div class="popup-row"><span class="popup-label">Speed</span><span class="popup-value">${p.speed_kts != null ? Math.round(p.speed_kts) + ' kts' : '--'}</span></div>
        <div class="popup-row"><span class="popup-label">Heading</span><span class="popup-value">${p.heading_deg != null ? Math.round(p.heading_deg) + '&deg;' : '--'}</span></div>
        <div class="popup-row"><span class="popup-label">VRate</span><span class="popup-value">${p.vertical_rate_fpm != null ? p.vertical_rate_fpm + ' fpm' : '--'}</span></div>
        <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap;">
            <a href="/aircraft/${p.icao}">Detail &rarr;</a>
            ${p.registration ? `<a href="https://www.planespotters.net/search?q=${encodeURIComponent(p.registration)}" target="_blank" rel="noopener">Photos</a>` : `<a href="https://www.planespotters.net/hex/${hexIcao}" target="_blank" rel="noopener">Photos</a>`}
            <a href="https://globe.adsbexchange.com/?icao=${hexIcao}" target="_blank" rel="noopener">ADSBx</a>
        </div>
    </div>`;
}

// --- Draw altitude-colored trail ---
function drawTrail(icao, points) {
    // Remove old trail
    if (trailLines[icao]) {
        trailLines[icao].forEach(seg => map.removeLayer(seg));
    }
    trailLines[icao] = [];

    if (!trailsEnabled) return;
    if (points.length < 2) return;

    for (let i = 1; i < points.length; i++) {
        const prev = points[i - 1];
        const curr = points[i];
        const alt = curr[2];  // altitude_ft
        const color = altColor(alt);
        // Fade older segments
        const opacity = 0.3 + 0.7 * (i / points.length);
        const seg = L.polyline(
            [[prev[0], prev[1]], [curr[0], curr[1]]],
            { color: color, weight: 2.5, opacity: opacity }
        ).addTo(map);
        trailLines[icao].push(seg);
    }
}

// --- Dynamic map center from receiver ---
function centerOnReceiver() {
    if (mapCentered) return;
    fetch('/api/stats')
        .then(r => r.json())
        .then(data => {
            if (data.receiver && data.receiver.lat && data.receiver.lon) {
                map.setView([data.receiver.lat, data.receiver.lon], 8);
                mapCentered = true;

                // Add receiver marker
                L.circleMarker([data.receiver.lat, data.receiver.lon], {
                    radius: 6, color: '#00aaff', fillColor: '#00aaff',
                    fillOpacity: 0.8, weight: 1,
                }).addTo(map).bindTooltip(data.receiver.name || 'Receiver', {
                    permanent: true, direction: 'right',
                    className: 'dark-tooltip',
                });
            }
        })
        .catch(() => {});
}

// --- Stats overlay ---
function updateStats() {
    fetch('/api/stats')
        .then(r => r.json())
        .then(s => {
            document.getElementById('so-positions').textContent = (s.positions || 0).toLocaleString();
            document.getElementById('so-events').textContent = s.events || 0;
            if (s.capture_start) {
                const elapsed = Date.now() / 1000 - s.capture_start;
                const h = Math.floor(elapsed / 3600);
                const m = Math.floor((elapsed % 3600) / 60);
                document.getElementById('so-uptime').textContent = h > 0 ? `${h}h ${m}m` : `${m}m`;
            }
        })
        .catch(() => {});
}

// --- Main update loop ---
function updateMap() {
    // Fetch positions and trails in parallel
    Promise.all([
        fetch(`/api/positions?minutes=${trailMinutes}`).then(r => r.json()),
        fetch(`/api/trails?minutes=${trailMinutes}`).then(r => r.json()),
    ]).then(([posData, trailData]) => {
        document.getElementById('ac-count').textContent = posData.count;
        document.getElementById('so-aircraft').textContent = posData.count;
        const tbody = document.querySelector('#ac-table tbody');
        tbody.innerHTML = '';

        const seen = new Set();
        posData.positions.forEach(p => {
            const key = p.icao;
            seen.add(key);

            // Draw trail (always call to clear stale segments)
            drawTrail(key, trailData.trails[key] || []);

            // Update or create marker
            const acType = classifyAircraft(p);
            if (markers[key]) {
                markers[key].setLatLng([p.lat, p.lon]);
                markers[key].setIcon(acIcon(p.heading_deg, p.is_military, acType));
                markers[key].setPopupContent(popupHtml(p, acType));
            } else {
                markers[key] = L.marker([p.lat, p.lon], {
                    icon: acIcon(p.heading_deg, p.is_military, acType),
                }).addTo(map);
                markers[key].bindPopup(popupHtml(p, acType), { maxWidth: 250 });
            }

            const label = p.callsign || p.registration || p.icao;
            markers[key].bindTooltip(label, {
                permanent: false,
                direction: 'right',
                className: 'dark-tooltip',
            });

            // Sidebar row
            const cls = p.is_military ? 'mil' : '';
            const hdg = p.heading_deg != null ? Math.round(p.heading_deg) + '°' : '-';
            tbody.innerHTML += `<tr>
                <td><a href="/aircraft/${p.icao}" class="${cls}">${p.icao}</a></td>
                <td>${p.callsign || p.registration || '-'}</td>
                <td>${p.altitude_ft != null ? p.altitude_ft.toLocaleString() : '-'}</td>
                <td>${p.speed_kts ? Math.round(p.speed_kts) : '-'}</td>
                <td>${hdg}</td>
            </tr>`;
        });

        // Remove markers + trails for aircraft no longer in response
        Object.keys(markers).forEach(key => {
            if (!seen.has(key)) {
                map.removeLayer(markers[key]);
                delete markers[key];
                if (trailLines[key]) {
                    trailLines[key].forEach(seg => map.removeLayer(seg));
                    delete trailLines[key];
                }
            }
        });
    }).catch(err => console.error('Update failed:', err));
}

// --- Airport layer ---
let airportLayer = L.layerGroup().addTo(map);
let allAirports = null;

const aptIcons = {
    large_airport: L.divIcon({
        className: '',
        html: `<svg width="18" height="18" viewBox="0 0 18 18">
            <rect x="3" y="8" width="12" height="2.5" rx="1" fill="#ffaa00" opacity="0.9"/>
            <rect x="7.5" y="2" width="2.5" height="14" rx="1" fill="#ffaa00" opacity="0.9"/>
        </svg>`,
        iconSize: [18, 18], iconAnchor: [9, 9],
    }),
    medium_airport: L.divIcon({
        className: '',
        html: `<svg width="14" height="14" viewBox="0 0 14 14">
            <rect x="2" y="6" width="10" height="2" rx="1" fill="#cc8800" opacity="0.8"/>
            <rect x="6" y="1" width="2" height="12" rx="1" fill="#cc8800" opacity="0.8"/>
        </svg>`,
        iconSize: [14, 14], iconAnchor: [7, 7],
    }),
    small_airport: L.divIcon({
        className: '',
        html: `<svg width="10" height="10" viewBox="0 0 10 10">
            <circle cx="5" cy="5" r="3" fill="#997700" opacity="0.7"/>
        </svg>`,
        iconSize: [10, 10], iconAnchor: [5, 5],
    }),
};

function getAptFilters() {
    return {
        large_airport: document.getElementById('apt-large').checked,
        medium_airport: document.getElementById('apt-medium').checked,
        small_airport: document.getElementById('apt-small').checked,
    };
}

['apt-large', 'apt-medium', 'apt-small'].forEach(id => {
    document.getElementById(id).addEventListener('change', () => {
        if (!allAirports) {
            fetch('/api/airports').then(r => r.json()).then(data => {
                allAirports = data.airports;
                renderVisibleAirports();
            });
        } else {
            renderVisibleAirports();
        }
    });
});

function renderVisibleAirports() {
    airportLayer.clearLayers();
    if (!allAirports) return;
    const filters = getAptFilters();
    if (!filters.large_airport && !filters.medium_airport && !filters.small_airport) return;
    const bounds = map.getBounds();
    allAirports.forEach(apt => {
        if (!filters[apt.type]) return;
        if (!bounds.contains([apt.lat, apt.lon])) return;
        const icon = aptIcons[apt.type] || aptIcons.small_airport;
        const typeLabel = apt.type === 'large_airport' ? 'Major' : apt.type === 'medium_airport' ? 'Medium' : 'Small';
        const popupContent = `<div class="ac-popup">
            <div class="popup-title" style="color:#ffaa00;">${apt.icao}</div>
            <div class="popup-row"><span class="popup-label">Name</span><span class="popup-value">${apt.name}</span></div>
            <div class="popup-row"><span class="popup-label">Type</span><span class="popup-value">${typeLabel}</span></div>
            <div class="popup-row"><span class="popup-label">Elevation</span><span class="popup-value">${apt.elevation_ft.toLocaleString()} ft</span></div>
            <div class="popup-row"><span class="popup-label">Coords</span><span class="popup-value">${apt.lat.toFixed(4)}, ${apt.lon.toFixed(4)}</span></div>
            <div style="margin-top:6px;">
                <a href="https://www.airnav.com/airport/${apt.icao}" target="_blank">AirNav &rarr;</a>
                &nbsp;
                <a href="https://skyvector.com/airport/${apt.icao}" target="_blank">SkyVector &rarr;</a>
            </div>
        </div>`;
        L.marker([apt.lat, apt.lon], { icon, interactive: true })
            .bindTooltip(`${apt.icao} — ${apt.name}`, {
                permanent: false, direction: 'right',
                className: 'dark-tooltip',
            })
            .bindPopup(popupContent, { maxWidth: 280 })
            .addTo(airportLayer);
    });
}

map.on('moveend', renderVisibleAirports);

// --- Heatmap layer ---
let heatLayer = null;
let heatmapEnabled = false;

document.getElementById('heatmap-toggle').addEventListener('change', function() {
    heatmapEnabled = this.checked;
    if (!heatmapEnabled && heatLayer) {
        map.removeLayer(heatLayer);
        heatLayer = null;
    }
    if (heatmapEnabled) updateHeatmap();
});

function updateHeatmap() {
    if (!heatmapEnabled) return;
    fetch('/api/trails?limit=200')
        .then(r => r.json())
        .then(data => {
            const points = [];
            Object.values(data.trails).forEach(trail => {
                trail.forEach(p => {
                    points.push([p[0], p[1], 0.5]);  // lat, lon, intensity
                });
            });
            if (heatLayer) map.removeLayer(heatLayer);
            if (points.length > 0) {
                heatLayer = L.heatLayer(points, {
                    radius: 15, blur: 20, maxZoom: 12,
                    gradient: {0.2: '#0000ff', 0.4: '#00ff88', 0.6: '#ffff00', 0.8: '#ff8800', 1.0: '#ff0000'},
                }).addTo(map);
            }
        })
        .catch(() => {});
}

// --- Trail toggle ---
let trailsEnabled = true;
const trailToggle = document.getElementById('trail-toggle');
trailToggle.addEventListener('change', function() {
    trailsEnabled = this.checked;
    if (!trailsEnabled) {
        Object.keys(trailLines).forEach(k => {
            trailLines[k].forEach(seg => map.removeLayer(seg));
        });
    }
    saveState();
});

// --- Trail duration slider ---
const trailDurSteps = [5, 15, 30, 60, 120, 360, 720, 1440]; // minutes
const trailDurLabels = ['5m', '15m', '30m', '1h', '2h', '6h', '12h', '24h'];
let trailMinutes = 60; // default 1 hour
const trailDurSlider = document.getElementById('trail-dur-slider');
const trailDurLabel = document.getElementById('trail-dur-label');
trailDurSlider.addEventListener('input', function() {
    const idx = parseInt(this.value);
    trailMinutes = trailDurSteps[idx];
    trailDurLabel.textContent = trailDurLabels[idx];
    saveState();
    updateMap(); // immediate refresh
});

// --- Persist checkbox state in localStorage ---
const STATE_KEY = 'adsb-map-state';
function saveState() {
    const state = {
        trails: document.getElementById('trail-toggle').checked,
        trailDur: parseInt(trailDurSlider.value),
        heatmap: document.getElementById('heatmap-toggle').checked,
        aptLarge: document.getElementById('apt-large').checked,
        aptMedium: document.getElementById('apt-medium').checked,
        aptSmall: document.getElementById('apt-small').checked,
        zoom: map.getZoom(),
        center: [map.getCenter().lat, map.getCenter().lng],
    };
    localStorage.setItem(STATE_KEY, JSON.stringify(state));
}
function restoreState() {
    try {
        const raw = localStorage.getItem(STATE_KEY);
        if (!raw) return;
        const s = JSON.parse(raw);
        if (s.trails !== undefined) { trailToggle.checked = s.trails; trailsEnabled = s.trails; }
        if (s.trailDur !== undefined) {
            trailDurSlider.value = s.trailDur;
            trailMinutes = trailDurSteps[s.trailDur];
            trailDurLabel.textContent = trailDurLabels[s.trailDur];
        }
        if (s.heatmap) { document.getElementById('heatmap-toggle').checked = true; heatmapEnabled = true; }
        if (s.aptLarge) document.getElementById('apt-large').checked = true;
        if (s.aptMedium) document.getElementById('apt-medium').checked = true;
        if (s.aptSmall) document.getElementById('apt-small').checked = true;
        if (s.center && s.zoom) { map.setView(s.center, s.zoom); mapCentered = true; }
        // Trigger airport + heatmap load if restored
        if (s.aptLarge || s.aptMedium || s.aptSmall) {
            if (!allAirports) {
                fetch('/api/airports').then(r => r.json()).then(data => {
                    allAirports = data.airports;
                    renderVisibleAirports();
                });
            }
        }
        if (s.heatmap) updateHeatmap();
    } catch(e) {}
}
// Save on map move and checkbox changes
map.on('moveend', saveState);
['heatmap-toggle', 'apt-large', 'apt-medium', 'apt-small'].forEach(id => {
    document.getElementById(id).addEventListener('change', saveState);
});

// --- Initialize ---
restoreState();
centerOnReceiver();
updateMap();
updateStats();
setInterval(updateMap, 1000);
setInterval(updateStats, 10000);
setInterval(updateHeatmap, 15000);
</script>
{% endblock %}
